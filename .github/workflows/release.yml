name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build-native-rust:
    strategy:
      matrix:
        include:
          - os: windows-latest
            artifact: luau-docgen-windows-x64
            bin: packages/luau-docgen/native/target/release/luau-docgen.exe
          - os: ubuntu-latest
            artifact: luau-docgen-linux-x64
            bin: packages/luau-docgen/native/target/release/luau-docgen
          - os: macos-latest
            artifact: luau-docgen-macos-x64
            bin: packages/luau-docgen/native/target/release/luau-docgen
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup Rust
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          cache-workspaces: |
            packages/luau-docgen/native -> target

      - name: Build Native Binary (Release)
        working-directory: packages/luau-docgen/native
        run: cargo build --release

      - name: Upload Native Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact }}
          path: ${{ matrix.bin }}

  build-cli-pkg:
    strategy:
      matrix:
        include:
          - os: windows-latest
            artifact: bakerywave-windows-x64
            target: node18-win-x64
            output: bakerywave.exe
          - os: ubuntu-latest
            artifact: bakerywave-linux-x64
            target: node18-linux-x64
            output: bakerywave-linux
          - os: macos-latest
            artifact: bakerywave-macos-x64
            target: node18-macos-x64
            output: bakerywave-macos
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install Dependencies
        run: npm ci

      - name: Build Executable
        run: npx pkg packages/bakerywave/package.json -t ${{ matrix.target }} -o ${{ matrix.output }}

      - name: Upload Bakerywave Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact }}
          path: ${{ matrix.output }}

  docs-template-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install root dependencies
        run: npm ci

      - name: Install website dependencies
        working-directory: tests/luau-module-project/website
        run: npm ci

      - name: Run tests
        working-directory: tests/luau-module-project/website
        run: npm test

  publish-npm:
    needs: [build-native-rust, build-cli-pkg, docs-template-test]
    runs-on: ubuntu-latest
    if: ${{ secrets.NPM_TOKEN != '' }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org'
          cache: 'npm'

      - name: Install Dependencies
        run: npm ci

      - name: Publish Packages
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          set -euo pipefail

          publish_if_needed() {
            local package_name="$1"
            local package_dir="$2"
            local package_version
            package_version="$(node -p "require('./${package_dir}/package.json').version")"

            if npm view "${package_name}@${package_version}" version >/dev/null 2>&1; then
              echo "[release] ${package_name}@${package_version} already published. skipping."
              return 0
            fi

            echo "[release] publishing ${package_name}@${package_version}"
            npm publish "./${package_dir}" --access public
          }

          publish_if_needed "@storybakery/luau-docgen" "packages/luau-docgen"
          publish_if_needed "@storybakery/docusaurus-plugin-reference" "packages/docusaurus-plugin-reference"
          publish_if_needed "@storybakery/docusaurus-plugin-search-index" "packages/docusaurus-plugin-search-index"
          publish_if_needed "@storybakery/docs-theme" "packages/docs-theme"
          publish_if_needed "@storybakery/docs-preset" "packages/docs-preset"
          publish_if_needed "@storybakery/create-docs" "packages/create-docs"
          publish_if_needed "@storybakery/bakerywave" "packages/bakerywave"

  publish-release:
    needs: [build-native-rust, build-cli-pkg, docs-template-test]
    runs-on: ubuntu-latest

    steps:
      - name: Download Native Artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: luau-docgen-*
          path: dist/native

      - name: Download Bakerywave Artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: bakerywave-*
          path: dist/cli

      - name: Zip Release
        run: |
          cd dist
          for dir in native/*; do
            name=$(basename "$dir")
            zip -r "${name}.zip" "$dir"
          done
          for dir in cli/*; do
            name=$(basename "$dir")
            zip -r "${name}.zip" "$dir"
          done
          ls -la *.zip

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: dist/*.zip
          draft: true
          generate_release_notes: true
